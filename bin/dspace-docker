#!/bin/bash
#
# description: DSpace Docker environment
#

start() {
  echo "Starting the DSpace Docker Container: "

  if [[ $( docker ps --all --filter="name=dspace" --format "{{.ID}}" ) ]]; then
    docker start \
      dspace
  else
    docker run \
      --interactive \
      --tty \
      --name dspace \
      --mount src="$(pwd)/guest",target=/host,type=bind \
      --mount src="$(pwd)/guest/opt",target=/opt,type=bind \
      --mount src="$(pwd)/guest/var/opt",target=/var/opt,type=bind \
      -d=true \
      -p 8888:8080 \
      pulibrary/dspace-docker:base
  fi

  echo

  return 0
}

stop() {
  echo "Stopping the DSpace Docker Container: "
  docker stop dspace
  echo

  return 0
}

status() {
  if [[ $( docker ps --filter="name=dspace" --format "{{.ID}}" ) ]]; then
    echo "Running"
  else
    echo "Stopped"
    return 1
  fi

  return 0
}

restart() {
  if [[ $( docker ps --all --filter="name=dspace" --format "{{.ID}}" ) ]]; then
    docker restart dspace
  else
    start
  fi
}

reload() {
  restart
}

build() {
  echo "Building the DSpace Docker Image: "
  docker build \
    --file ./Dockerfile \
    --tag pulibrary/dspace-docker:base \
    .

  echo

  return 0
}

provision() {
  echo "Provisioning the DSpace Docker Container: "
  docker exec \
    -it \
    dspace \
    ansible-playbook -e 'install_dspace=false' -vvv /opt/ansible/playbooks/docker.yml

  echo

  return 0
}

shell() {
  docker exec \
    --interactive \
    --tty \
    --user=dspace \
    --workdir=/home/dspace \
    dspace \
    bash

  echo

  return 0
}

root_shell() {
  docker exec \
    --interactive \
    --tty \
    --user=root \
    --workdir=/root \
    dspace \
    bash

  echo

  return 0
}

postgres_shell() {
  docker exec \
    --interactive \
    --tty \
    --user=postgres \
    --workdir=/var/lib/postgresql \
    dspace \
    bash

  echo

  return 0
}

case "$1" in
  build)
    build
    ;;

  start)
    start
    ;;

  provision)
    provision
    ;;

  shell)
    shell
    ;;

  root-shell)
    root_shell
    ;;

  postgres-shell)
    postgres_shell
    ;;

  stop)
    stop
    ;;

  status)
    status
    ;;

  restart)
    restart
    ;;

  reload)
    reload
    ;;

  *)
    echo "Usage: {start|stop|status|reload|restart|build|provision|shell|root-shell|postgres-shell}"
    exit 1
    ;;
esac

exit $?

